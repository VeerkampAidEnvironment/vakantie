{% extends "base.html" %}
{% block content %}

<div class="container py-3">

  <!-- =========================
       HEADER
  ========================== -->
  <h2>{{ info.destination }} ({{ info.year }})</h2>

  {% if info.participants %}
    <p><strong>Participants:</strong> {{ info.participants | join(", ") }}</p>
  {% endif %}

  {% if info.activities %}
    <p><strong>Activities:</strong> {{ info.activities | join(", ") }}</p>
  {% endif %}

  <hr>

  <!-- =========================
       MAP
  ========================== -->
  <h4>Map overview</h4>
  <div id="vacation-map" style="height: 500px; width: 100%; border-radius: 8px;"></div>

  <hr>

  <!-- =========================
       ACTIVITIES LIST
  ========================== -->
  <h4>Routes</h4>
  <ul>
    {% for geo in geojson_files %}
      <li>
        <strong>{{ geo.activity }}</strong> – {{ geo.filename }}
      </li>
    {% endfor %}
  </ul>

  <hr>

  <!-- =========================
       CLIMBING
  ========================== -->
  {% if climbing %}
    <h4>Climbing</h4>
    {% for area, data in climbing.items() %}
      <details class="mb-4">
        <summary style="cursor:pointer;">
          <strong>{{ area }}</strong>
          ({{ data.routes | length }} routes)
        </summary>

        {% if data.routes %}
          <div class="table-responsive mt-3">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Route</th>
                  <th>Moeilijkheid</th>
                  <th>Lengte</th>
                  <th>Max</th>
                  <th>Sem</th>
                  <th>Paul</th>
                  <th>Trudy</th>
                </tr>
              </thead>
              <tbody>
                {% for r in data.routes %}
                  <tr>
                    <td>{{ r.routenaam }}</td>
                    <td>{{ r.moeilijkheid or "-" }}</td>
                    <td>{{ r.lengte or "-" }}</td>
                    <td>{{ r.klimmers.max or "-" }}</td>
                    <td>{{ r.klimmers.sem or "-" }}</td>
                    <td>{{ r.klimmers.paul or "-" }}</td>
                    <td>{{ r.klimmers.trudy or "-" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="mt-2"><em>No routes listed</em></p>
        {% endif %}
      </details>
    {% endfor %}
  {% endif %}

  <hr>

  <!-- =========================
       PHOTOS
  ========================== -->
  <h4>Photos</h4>

  {% for activity, photos in photo_groups.items() %}
    <details class="mb-3">
      <summary style="cursor:pointer;">
        <strong>{{ activity }}</strong>
        ({{ photos | length }} photos)
      </summary>

      {% if photos %}
        <div class="d-flex flex-wrap gap-3 mt-3">
          {% for photo in photos %}
            <a href="{{ url_for('serve_photo', folder=folder, filename=photo) }}" target="_blank">
              <img
                loading="lazy"
                src="{{ url_for('serve_photo', folder=folder, filename=photo) }}"
                class="img-thumbnail"
                style="max-width: 200px;"
              >
            </a>
          {% endfor %}
        </div>
      {% else %}
        <p class="mt-2"><em>No photos</em></p>
      {% endif %}
    </details>
  {% endfor %}

</div>

<!-- =========================
     MAP SCRIPTS
========================== -->

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

<script>
/* global L */

const map = L.map("vacation-map").setView([46.8, 9.8], 8);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

/* =========================
   DATA FROM FLASK
========================= */
const geojsonFiles = {{ geojson_files | tojson }};
const folder = {{ folder | tojson }};
const climbing = {{ climbing | default(None) | tojson }};

/* =========================
   COLOR SYSTEM
========================= */
/* Base colors per activity */
const baseColors = {
  "Wandelen": [46, 139, 87],     // green
  "Fietsen": [52, 152, 219],    // blue
  "Alpineren": [26, 188, 156],  // teal
  "Via Ferrata": [155, 89, 182] // purple
};

/* Generate lighter/darker shades */
function shadeColor([r,g,b], factor) {
  return `rgb(${Math.round(r*factor)},${Math.round(g*factor)},${Math.round(b*factor)})`;
}

/* =========================
   ROUTES + LEGEND
========================= */
let layers = [];
let legendItems = [];

const activityCounts = {};

geojsonFiles.forEach(geo => {
  activityCounts[geo.activity] = (activityCounts[geo.activity] || 0) + 1;
});

const activityIndex = {};

geojsonFiles.forEach(geo => {
  const base = baseColors[geo.activity] || [120,120,120];
  const idx = activityIndex[geo.activity] || 0;
  const total = activityCounts[geo.activity];

  const factor = 0.6 + (idx / Math.max(1, total-1)) * 0.4;
  const color = shadeColor(base, factor);

  activityIndex[geo.activity] = idx + 1;

  const activitySlug = geo.activity.toLowerCase().replace(/\s+/g, "_");
  const url = `/vacation/${folder}/geojson/${activitySlug}/${geo.filename}`;

  fetch(url)
    .then(r => r.json())
    .then(geojson => {
      const layer = L.geoJSON(geojson, {
        style: {
          color,
          weight: 3
        }
      }).addTo(map);

      layer.bindPopup(`
        <b>${geo.activity}</b><br>
        ${geo.filename}
      `);

      layers.push(layer);

      legendItems.push({
        label: `${geo.activity} – ${geo.filename}`,
        color
      });

      updateLegend();
      fitBounds();
    });
});

/* =========================
   CLIMBING MARKERS
========================= */
if (climbing) {
  Object.entries(climbing).forEach(([area, data]) => {
    if (!data.coords || data.coords.length !== 2) return;

    const marker = L.circleMarker(data.coords, {
      radius: 7,
      color: "#8e44ad",
      fillColor: "#8e44ad",
      fillOpacity: 0.85,
      weight: 2
    }).addTo(map);

    marker.bindPopup(`<b>${area}</b><br>Routes: ${data.routes ? data.routes.length : 0}`);
    layers.push(marker);
  });
}

/* =========================
   FIT MAP BOUNDS
========================= */
function fitBounds() {
  if (!layers.length) return;
  const group = L.featureGroup(layers);
  if (group.getBounds().isValid()) {
    map.fitBounds(group.getBounds(), { padding: [40,40], maxZoom: 14 });
  }
}

/* =========================
   LEGEND
========================= */
const legend = L.control({ position: "bottomright" });

legend.onAdd = function() {
  const div = L.DomUtil.create("div", "legend");
  div.innerHTML = "<h5>Routes</h5><div id='legend-items'></div>";
  return div;
};

legend.addTo(map);

function updateLegend() {
  const container = document.getElementById("legend-items");
  if (!container) return;

  container.innerHTML = "";
  legendItems.forEach(item => {
    container.innerHTML += `
      <div style="display:flex;align-items:center;gap:8px;margin:4px 0">
        <span style="width:14px;height:14px;background:${item.color};
              border-radius:3px;border:1px solid #555"></span>
        <span style="font-size:12px">${item.label}</span>
      </div>
    `;
  });
}
</script>

{% endblock %}
